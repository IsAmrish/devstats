# Adding new project
  
To add new project follow instructions:
- `crontab -e` and turn off `devstats`, `gha2db_sync` and `webhook`. Kill running `webhook` instance: `killall webhook` (to avoid auto deploying wip states).
- Add project entry to `projects.yaml` file. Find projects orgs, repos, select start date, eventually add test coverage for complex regular expression in `regexp_test.go`.
- To identify repo and/or org name changes, date ranges for entrire projest use `util_sql/(repo|org)_name_changes_bigquery.sql` replacing name there.
- Main repo can be empty `''` - in this case only two annotations will be added: 'start date - CNCF join date' and 'CNCF join date - now".
- Set project databases (Influx and Postgres).
- Set it to `disabled: true` for now, or turn of webhook to skip automatic deploys while in wip state (`crontab -e` to disable `webhook` + `killall webhook`).
- CNCF join dates are listed here: https://github.com/cncf/toc#projects.
- Add this new project config to 'All' project in `projects.yaml all/psql.sh grafana/dashboards/all/dashboards.json scripts/all/repo_groups.sql devel/calculate_hours.sh`. Add entire new project as a new repo group in 'All' project.
- Update `cron/cron_db_backup_all.sh devel/reinit.sh devel/import_affs.sh devel/update_affs.sh devel/add_single_metric_all.sh grafana/copy_grafana_dbs.sh devel/get_grafana_dbs.sh devel/tags.sh devel/get_all_databases.sh devel/update_grafanas.sh devel/copy_grafanas.sh` but do not install yet.
- Add new domain for the project: `projectname.cncftest.io`. If using wildcard domain like `*.devstats.cncf.io` - this step is not needed.
- Add google analytics for the new domain and update /etc/grafana.projectname/grafana.ini with its `UA-...`.
- Copy standard grafana distro for new project: `cp -R /usr/share/grafana /usr/share/grafana.projectname/`.
- Make sure that you pull newest cncf/artwork: `cd ~/dev/cncf/artwork; git pull; cd ~/dev/go/src/devstats`.
- Generate icons for new project: `./grafana/img/projectname32.png`, `./grafana/img/projectname.svg`: update & run `./grafana/create_images.sh`.
- Update `grafana/copy_artwork_icons.sh apache/www/copy_icons.sh grafana/create_images.sh grafana/change_title_and_icons_all.sh`.
- Copy setup scripts and then adjust them:
- `cp -R oldproject/ projectname/`, `vim projectname/*`.
- You need to set correct project main GitHub repository and annotations match regexp in `projects.yaml` to have working annotations and quick ranges.
- Copy `metrics/oldproject` to `metrics/projectname`, those files will need tweaks too. Specially `./metrics/projectname/gaps*.yaml` files. Please use Grafana's "null as zero" instead of using manuall filling gaps. This simplifies metrics a lot.
- `cp -Rv scripts/oldproject/ scripts/projectname`, `vim scripts/projectname/*`.
- Create Postgres database for new project: `sudo -u postgres psql`
- `create database projectname;`
- `grant all privileges on database "projectname" to gha_admin;`
- If running on the test server: generate Postgres data: `PG_PASS=... IDB_PASS=... IDB_HOST=172.17.0.1 ./projectname/psql.sh`.
- If running on the production server: `wget https://cncftest.io/projectname.sql.xz`, `xz -d projectname.sql.xz`, `sudo -u postgres psql projectname < projectname.sql`.
- When data is imported into Postgres: projectname, you need to update `metrics/projectname/gaps*.yaml` (with top companies & repo groups). This is only needed when you're using gaps (which you shouldn't).
- Using `./projectname/top_n_companies.sh ./projectname/top_n_repos_groups.sh`.
- There are two kinds of repo group names: direct from query, but also with special characters replaced with "_"
- You should copy those from query, put there where needed and do VIM replace: `:'<,'>s/[-/.: `]/_/g`, `:'<,'>s/[A-Z]/\L&/g`.
- Run regenerate all InfluxData script `./projectname/reinit.sh`.
- Merge new project into 'All' project using `PG_PASS=pwd ./all/add_project.sh projname`.
- Run regenerate 'All' project InfluxData script `./all/reinit.sh`.
- `cp -Rv grafana/oldproject/ grafana/projectname/` and then update files. Usually `%s/oldproject/newproject/g|w|next`.
- `cp -Rv grafana/dashboards/oldproject/ grafana/dashboards/projectname/` and then update files. Usually `%s/"oldproj"/"newproj"/g|%s/DS_OLDPROJ/DS_NEWPROJ/g|%s/OldProj/NewProj/g|w|next`.
- Be careful with `dashboards.json` because it contains list of all projects so you shouldn't replace oldproj with newproj - but add new entry instead.
- Update: `grafana/copy_artwork_icons.sh apache/www/copy_icons.sh grafana/create_images.sh`.
- Update `projects.yaml` remove `disabled: true` for new project (if needed).
- `make install` to install all changed stuff.
- Copy directories `/etc/grafana`, `/usr/share/grafana`, `/var/lib/grafana` from standard unmodified installation adding .projectname to their names.
- You can use `grafana/etc/grafana.ini.example` as a base config file (but note that some options are redacted in this example file).
- Update `./grafana/proj/change_title_and_icons.sh` to use right names. Run it with `GRAFANA_DATA=/usr/share/grafana.projectname/ ./grafana/projectname/change_title_and_icons.sh`.
- Update `/etc/grafana.projectname/grafana.ini` - set all config options from `GRAFANA.md`, `MULTIPROJECT.md`.
- Follow `Grafana sessions in Postgres` from MULTIPROJECT.md:
- `sudo -u postgres psql`
- `create database projectname_grafana_sessions;`
- `grant all privileges on database "projectname_grafana_sessions" to gha_admin;`
- Quit `psql` and run: `sudo -u postgres psql projectname_grafana_sessions < util_sql/grafana_session_table.sql`.
- You now need Apache proxy and SSL, please follow instructions from APACHE.md and SSL.md
- Apache part is to update `/var/www/html/index.html apache/www/index_* /etc/apache2/sites-enabled/* apache/sites-enabled/*` files.
- SSL part is to issue certificate for new domain and setup proxy.
- Start new grafana: `./grafana/projectname/grafana_start.sh &` or `killall grafana-server`, `./grafana/start_all_grafanas.sh`, `ps -aux | grep grafana-server`.
- Update Apache config to proxy https to new Grafana instance: `vim /etc/apache2/sites-enabled/000-default-le-ssl.conf`, `service apache2 restart`
- Issue new SSL certificate as described in `SSL.md` (test server): `sudo certbot --apache -d 'cncftest.io,k8s.cncftest.io,prometheus.cncftest.io,opentracing.cncftest.io,fluentd.cncftest.io,linkerd.cncftest.io,grpc.cncftest.io,coredns.cncftest.io,containerd.cncftest.io,rkt.cncftest.io,cni.cncftest.io,envoy.cncftest.io,jaeger.cncftest.io,notary.cncftest.io,tuf.cncftest.io,rook.cncftest.io,vitess.cncftest.io,opencontainers.cncftest.io,all.cncftest.io,cncf.cncftest.io'`.
- Or (prod server): `sudo certbot --apache -d 'devstats.k8s.io,devstats.cncf.io,k8s.devstats.cncf.io,prometheus.devstats.cncf.io,opentracing.devstats.cncf.io,fluentd.devstats.cncf.io,linkerd.devstats.cncf.io,grpc.devstats.cncf.io,coredns.devstats.cncf.io,containerd.devstats.cncf.io,rkt.devstats.cncf.io,cni.devstats.cncf.io,envoy.devstats.cncf.io,jaeger.devstats.cncf.io,notary.devstats.cncf.io,tuf.devstats.cncf.io,rook.devstats.cncf.io,vitess.devstats.cncf.io,devstats.opencontainers.io,all.devstats.opencontainers.io'`.
- Or with standalone authenticator (test server): `sudo certbot -d 'cncftest.io,k8s.cncftest.io,prometheus.cncftest.io,opentracing.cncftest.io,fluentd.cncftest.io,linkerd.cncftest.io,grpc.cncftest.io,coredns.cncftest.io,containerd.cncftest.io,rkt.cncftest.io,cni.cncftest.io,envoy.cncftest.io,jaeger.cncftest.io,notary.cncftest.io,tuf.cncftest.io,rook.cncftest.io,vitess.cncftest.io,opencontainers.cncftest.io,all.cncftest.io,cncf.cncftest.io' --authenticator standalone --installer apache --pre-hook 'service apache2 stop' --post-hook 'service apache2 start'`
- Or with standalone authenticator (prod server): `sudo certbot -d 'devstats.k8s.io,devstats.cncf.io,k8s.devstats.cncf.io,prometheus.devstats.cncf.io,opentracing.devstats.cncf.io,fluentd.devstats.cncf.io,linkerd.devstats.cncf.io,grpc.devstats.cncf.io,coredns.devstats.cncf.io,containerd.devstats.cncf.io,rkt.devstats.cncf.io,cni.devstats.cncf.io,envoy.devstats.cncf.io,jaeger.devstats.cncf.io,notary.devstats.cncf.io,tuf.devstats.cncf.io,rook.devstats.cncf.io,vitess.devstats.cncf.io,devstats.opencontainers.io,all.devstats.opencontainers.io' --authenticator standalone --installer apache --pre-hook 'service apache2 stop' --post-hook 'service apache2 start'`
- Open `newproject.cncftest.io` login with admin/admin, change the default password and follow instructions from `GRAFANA.md`. If `./newproj/reinit.sh` is still running You can use `newproj_temp` as InfluxDB temporarity to speedup work. But finally change to `newproj`.
- Add new project to `/var/www/html/index.html`.
- Update and import `grafana/dashboards/{{proj}}/dashboards.json` dashboard on all remaining projects.
- Finally: `cp /var/lib/grafana.projectname/grafana.db /var/www/html/grafana.projectname.db` and/or `grafana/copy_grafana_dbs.sh`
- `crontab -e` and turn on `devstats` and eventually `webhook` (if was disabled).
