# Adding new project
  
To add new project follow instructions:
- `crontab -e` and turn off `devstats` and/or `gha2db_sync`.
- Add project entry to `projects.yaml` file. Find projects orgs, repos, select start date, eventually add test coverage for complex regular expression in `regexp_test.go`.
- Set project databases (Influx and Postgres).
- Set it to `disabled: true` for now.
- If not using `devstats` cron job then add project entry in `crontab.entry` but do not install new cron yet (that will be the last step).
- Update `./cron/cron_db_backup_all.sh`, `./devel/reinit.sh`, `./devel/import_affs.sh`, `./devel/add_single_metric_all.sh`, `grafana/copy_grafana_dbs.sh` but do not install yet.
- Add new domain for the project: `projectname.cncftest.io`. If using wildcard domain like *.devstats.cncf.io - this step is not needed.
- Add google analytics for the new domain and update /etc/grafana.projectname/grafana.ini with its `UA-...`.
- Search for all files defined for some existing project, for example `find . -iname "*oldproject*"`.
- Copy standard grafana distro for new project: `cp -R /usr/share/grafana /usr/share/grafana.projectname/`.
- Generate icons for new project: `./grafana/img/projectname32.png`, `./grafana/img/projectname.svg`: update & run `./grafana/create_images.sh`.
- SVG can be taken from cncf/artwork (should be color & square): `cp ~/dev/cncf/artwork/projectname/icon/color/projectname-icon-color.svg grafana/img/projectname.svg`.
- PNG should be 32bit RGBA 32x32 PNG. You can use `apt-get install imagemagick` and then: `convert ~/dev/cncf/artwork/projectname/icon/color/projectname-icon-color.png -resize 32x32 grafana/img/projectname32.png`.
- And/Or update `grafana/copy_artwork_icons.sh`, `apache/www/copy_icons.sh`, `grafana/create_images.sh`.
- Update `grafana/change_title_and_icons_all.sh`.
- Copy setup scripts and then adjust them:
- `cp -R oldproject/ projectname/`, `mv projectname/oldproject.sh projectname/projectname.sh`, `vim projectname/*`.
- You need to set correct project main GitHub repository and annotations match regexp in `projects.yaml` to have working annotations and quick ranges.
- Copy `metrics/oldproject` to `metrics/projectname`, those files will need tweaks too. Specially `./metrics/projectname/gaps.yaml`.
- `cp -Rv scripts/oldproject/ scripts/projectname`, `vim scripts/projectname/*`.
- Create Postgres database for new project: `sudo -u postgres psql`
- `create database projectname;`
- `grant all privileges on database "projectname" to gha_admin;`
- If running on the test server: generate Postgres data: `PG_PASS=... IDB_PASS=... IDB_HOST=172.17.0.1 ./projectname/projectname.sh`
- If running on the production server: `wget https://cncftest.io/projectname.sql.xz`, `xz -d projectname.sql.xz`, `sudo -u postgres psql projectname < projectname.sql`.
- When data is imported into Postgres: projectname, You need to update `metrics/projectname/gaps.yaml`.
- Using `./metrics/projectname/companies_tags.sql`,  `./projectname/top_n_companies.sh`.
- And `./projectname/top_n_repos_groups.sh`. Usually no repo groups are set up on new projects, currently only Kubernetes uses this.
- There are two kinds of repo group names: direct from query, but also with special characters replaced with "_"
- You should copy those from query, put there where needed and do VIM replace: `:'<,'>s/[-/.: `]/_/g`, `:'<,'>s/[A-Z]/\L&/g`.
- Run regenerate all InfluxData script `./projectname/reinit.sh`.
- `cp -Rv grafana/oldproject/ grafana/projectname/` and then update files. Usually `%s/oldproject/newproject/g|w|next`.
- `cp -Rv grafana/dashboards/oldproject/ grafana/dashboards/projectname/` and then update files. Usually `%s/"oldproj"/"newproj"/g|%s/DS_OLDPROJ/DS_NEWPROJ/g|%s/OldProj/NewProj/g|w|next`.
- Update: `grafana/copy_artwork_icons.sh`, `apache/www/copy_icons.sh`, `grafana/create_images.sh`.
- Update `projects.yaml` remove `disabled: true` for new project.
- `make install` to install all changed stuff.
- Copy directories `/etc/grafana`, `/usr/share/grafana`, `/var/lib/grafana` from standard unmodified installation adding .projectname to their names.
- Update `./grafana/cncf/change_title_and_icons.sh` to use right names. Run it with `GRAFANA_DATA=/usr/share/grafana.projectname/ ./grafana/projectsname/change_title_and_icons.sh`.
- Update `/etc/grafana.projectname/grafana.ini` - set all config options from `GRAFANA.md`, `MULTIPROJECT.md`.
- Follow `Grafana sessions in Postgres` from MULTIPROJECT.md
- You now need Apache proxy and SSL, please follow instructions from APACHE.md and SSL.md
- Apache part is to update `/var/www/html/index.html` file, `apache/www/index_*` files and, `/etc/apache2/sites-enabled/*` files, `apache/sites-enabled/*` files
- SSL part is to issue certificate for new domain and setup proxy.
- Start new grafana: `./grafana/projectname/grafana_start.sh` or `killall grafana-server`, `./grafana/start_all_grafanas.sh`, `ps -aux | grep grafana-server`.
- Update Apache config to proxy https to new Grafana instance: `vim /etc/apache2/sites-enabled/000-default-le-ssl.conf`, `service apache2 restart`
- Issue new SSL certificate as described in `SSL.md` (test server): `sudo certbot --apache -d 'cncftest.io,k8s.cncftest.io,prometheus.cncftest.io,opentracing.cncftest.io,fluentd.cncftest.io,linkerd.cncftest.io,grpc.cncftest.io,coredns.cncftest.io,containerd.cncftest.io,newproj.cncftest.io,cncf.cncftest.io'`.
- Or (prod server): `sudo certbot --apache -d 'devstats.k8s.io,devstats.cncf.io,k8s.devstats.cncf.io,prometheus.devstats.cncf.io,opentracing.devstats.cncf.io,fluentd.devstats.cncf.io,linkerd.devstats.cncf.io,grpc.devstats.cncf.io,coredns.devstats.cncf.io,containerd.devstats.cncf.io,newproject.devstats.cncf.io'`.
- Open `newproject.cncftest.io` login with admin/admin, change the default password and follow instructions from `GRAFANA.md`.
- Add new project to `/var/www/html/index.html` and `grafana/dashboards/all_cncf_projects.json`.
- Finally: `cp /var/lib/grafana.projectname/grafana.db /var/www/html/grafana.projectname.db` and/or `grafana/copy_grafana_dbs.sh`
- `crontab -e` and turn on `devstats` and/or `gha2db_sync`.
